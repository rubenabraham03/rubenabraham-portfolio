<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Blackjack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0b1020;
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .game-root {
      background: #111827;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      width: 100%;
      max-width: 480px;
      box-sizing: border-box;
    }

    body.compact .game-root {
      max-width: 360px;
      padding: 0.75rem 0.9rem;
      font-size: 0.9rem;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    h1 {
      font-size: 1.15rem;
      margin: 0;
    }

    .balance {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
      opacity: 0.85;
    }

    .hand {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .card {
      border-radius: 0.4rem;
      padding: 0.3rem 0.45rem;
      background: #1f2937;
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 0.8rem;
      min-width: 2.1rem;
      text-align: center;
    }

    .card.hidden {
      background: linear-gradient(135deg, #4b5563, #111827);
      color: transparent;
    }

    .total {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .status {
      margin-top: 0.5rem;
      min-height: 1.4rem;
      font-size: 0.9rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    button {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: #1f2937;
      color: #f9fafb;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s, border-color 0.15s;
    }

    button.primary {
      background: #2563eb;
      border-color: #2563eb;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    button:not(:disabled):active {
      transform: translateY(1px);
    }

    .hint {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="game-root">
    <div class="game-header">
      <h1>Blackjack</h1>
      <div class="balance">Chips: <span id="chips">100</span></div>
    </div>

    <div class="dealer-area">
      <div class="section-title">Dealer</div>
      <div id="dealer-hand" class="hand"></div>
      <div id="dealer-total" class="total"></div>
    </div>

    <div class="player-area" style="margin-top:0.6rem;">
      <div class="section-title">You</div>
      <div id="player-hand" class="hand"></div>
      <div id="player-total" class="total"></div>
    </div>

    <div id="status" class="status"></div>

    <div class="controls">
      <button id="dealBtn" class="primary">Deal</button>
      <button id="hitBtn" disabled>Hit</button>
      <button id="standBtn" disabled>Stand</button>
      <button id="newRoundBtn" disabled>New round</button>
    </div>

    <div class="hint">
      Simple rules: try to get closer to 21 than the dealer without going over.
    </div>
  </div>

  <script>
    // Compact mode support (?compact=1)
    (function () {
      const params = new URLSearchParams(location.search);
      if (params.get("compact") === "1") {
        document.body.classList.add("compact");
      }
    })();

    const suits = ["♠", "♥", "♦", "♣"];
    const ranks = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];

    let deck = [];
    let playerHand = [];
    let dealerHand = [];
    let chips = 100;
    let roundActive = false;

    const dealerHandEl = document.getElementById("dealer-hand");
    const dealerTotalEl = document.getElementById("dealer-total");
    const playerHandEl = document.getElementById("player-hand");
    const playerTotalEl = document.getElementById("player-total");
    const statusEl = document.getElementById("status");
    const chipsEl = document.getElementById("chips");

    const dealBtn = document.getElementById("dealBtn");
    const hitBtn = document.getElementById("hitBtn");
    const standBtn = document.getElementById("standBtn");
    const newRoundBtn = document.getElementById("newRoundBtn");

    function createDeck() {
      const d = [];
      for (const s of suits) {
        for (const r of ranks) {
          d.push({ rank: r, suit: s });
        }
      }
      for (let i = d.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [d[i], d[j]] = [d[j], d[i]];
      }
      return d;
    }

    function cardValue(card) {
      if (card.rank === "A") return 11;
      if (["K", "Q", "J"].includes(card.rank)) return 10;
      return parseInt(card.rank, 10);
    }

    function handValue(hand) {
      let total = 0;
      let aces = 0;
      for (const c of hand) {
        total += cardValue(c);
        if (c.rank === "A") aces++;
      }
      while (total > 21 && aces > 0) {
        total -= 10;
        aces--;
      }
      return total;
    }

    function renderHands(hideDealerHole) {
      dealerHandEl.innerHTML = "";
      dealerHand.forEach((card, idx) => {
        const div = document.createElement("div");
        div.className = "card";
        if (hideDealerHole && idx === 1) {
          div.classList.add("hidden");
          div.textContent = "??";
        } else {
          div.textContent = card.rank + card.suit;
        }
        dealerHandEl.appendChild(div);
      });

      playerHandEl.innerHTML = "";
      playerHand.forEach((card) => {
        const div = document.createElement("div");
        div.className = "card";
        div.textContent = card.rank + card.suit;
        playerHandEl.appendChild(div);
      });

      if (hideDealerHole) {
        dealerTotalEl.textContent = "Total: ?";
      } else {
        dealerTotalEl.textContent = "Total: " + handValue(dealerHand);
      }

      playerTotalEl.textContent = "Total: " + handValue(playerHand);
    }

    function setControls({ canDeal, canHit, canStand, canNewRound }) {
      dealBtn.disabled = !canDeal;
      hitBtn.disabled = !canHit;
      standBtn.disabled = !canStand;
      newRoundBtn.disabled = !canNewRound;
    }

    function startRound() {
      deck = createDeck();
      playerHand = [];
      dealerHand = [];
      statusEl.textContent = "";
      roundActive = true;

      // Simple fixed bet for now
      chips -= 5;
      chipsEl.textContent = chips;

      // Deal two cards each
      playerHand.push(deck.pop(), deck.pop());
      dealerHand.push(deck.pop(), deck.pop());

      renderHands(true);
      statusEl.textContent = "Your turn. Hit or stand.";
      setControls({ canDeal: false, canHit: true, canStand: true, canNewRound: false });

      const playerVal = handValue(playerHand);
      if (playerVal === 21) {
        // Auto stand / blackjack
        dealerTurn(true);
      }
    }

    function endRound(message, payout) {
      if (typeof payout === "number") {
        chips += payout;
        chipsEl.textContent = chips;
      }
      statusEl.textContent = message;
      roundActive = false;
      setControls({ canDeal: false, canHit: false, canStand: false, canNewRound: true });
    }

    function playerHit() {
      if (!roundActive) return;
      playerHand.push(deck.pop());
      const val = handValue(playerHand);
      renderHands(true);

      if (val > 21) {
        // Player busts
        renderHands(false);
        endRound("You busted. Dealer wins.", 0);
      }
    }

    function dealerTurn(checkBlackjack) {
      renderHands(false);
      let playerVal = handValue(playerHand);
      let dealerVal = handValue(dealerHand);

      if (checkBlackjack && dealerVal === 21 && playerVal === 21) {
        endRound("Push. Both have blackjack.", 5); // return bet
        return;
      }
      if (checkBlackjack && dealerVal === 21) {
        endRound("Dealer has blackjack. You lose.", 0);
        return;
      }
      if (checkBlackjack && playerVal === 21) {
        endRound("Blackjack! You win.", 15); // 3:2 on 5 bet
        return;
      }

      while (dealerVal < 17) {
        dealerHand.push(deck.pop());
        dealerVal = handValue(dealerHand);
        renderHands(false);
      }

      playerVal = handValue(playerHand);
      dealerVal = handValue(dealerHand);

      if (dealerVal > 21) {
        endRound("Dealer busts. You win.", 10); // win 5
      } else if (dealerVal > playerVal) {
        endRound("Dealer wins with " + dealerVal + ".", 0);
      } else if (dealerVal < playerVal) {
        endRound("You win with " + playerVal + ".", 10);
      } else {
        endRound("Push. Bet returned.", 5);
      }
    }

    dealBtn.addEventListener("click", startRound);
    hitBtn.addEventListener("click", playerHit);
    standBtn.addEventListener("click", () => {
      if (!roundActive) return;
      dealerTurn(false);
    });
    newRoundBtn.addEventListener("click", () => {
      setControls({ canDeal: true, canHit: false, canStand: false, canNewRound: false });
      statusEl.textContent = "Tap Deal to start a new round.";
      dealerHandEl.innerHTML = "";
      playerHandEl.innerHTML = "";
      dealerTotalEl.textContent = "";
      playerTotalEl.textContent = "";
    });

    // Initial state
    setControls({ canDeal: true, canHit: false, canStand: false, canNewRound: false });
    statusEl.textContent = "Tap Deal to start.";
  </script>
</body>
</html>
